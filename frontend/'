import { EditorContent, useEditor } from "@tiptap/react";
import { useEffect, useState } from "react";
import axios from "axios";
import StarterKit from "@tiptap/starter-kit";
import { safe } from "../utils.ts";

type SaveStatus = "Idle" | "Saving..." | "Saved!" | "Error";

const TiptapEditor = () => {
    const [saveStatus, setSaveStatus] = useState<SaveStatus>("Idle");

    const editor = useEditor({
        extensions: [StarterKit],
        content: `<p>Loading content...</p>`,
        editorProps: {
            attributes: {
                class: "prose dark:prose-invert prose bg-gray-400\
                sm:prose-base lg:prose-lg xl:prose-2xl m-5 focus:outline-none text-white",
            },
        },
    });

        const documentID = "611519a4-849b-490f-90ef-2ab659f4bb3d";
    useEffect(() => {
        if (!editor) {
            return;
        }

        const fetchDocument = async () => {
            const [response, error] = await safe(
                axios.get(`http://localhost:8080/documents/${documentID}`),
            );

            if (error || !response?.data) {
                console.error(
                    "Failed to fetch document:",
                    error?.message ?? "No data",
                );
                editor.commands.setContent("Failed to get the content");
                return;
            }

            editor.commands.setContent(response.data.content);
        };
        fetchDocument();
    }, [editor]);

    const handleSave = async () => {
        if (!editor) {
            return;
        }

        setSaveStatus("Saving...");

        const htmlContent = editor.getHTML();
        const [response, error] = await safe(
            axios.put(`http://localhost:8080/documents/${documentID}`, {
        title: 'My Updated Title',
        content: htmlContent,
      });
        )
    };

    return (
        <div className="border border-gray-300 rounded-lg p-2">
            <EditorContent editor={editor} />
        </div>
    );
};

export default TiptapEditor;
